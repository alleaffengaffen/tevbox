name: Destroy a box

on:
  workflow_dispatch:
    inputs:
      tenant:
        required: true
        type: choice
        options:
        - alleaffengaffen
        - root
      hostname:
        required: true
        type: string
        description: "Hostname of the box to delete"

jobs:
  destory:
    name: "Destroy run"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@main
      - name: Set tokens correctly (root)
        if: github.event.inputs.tenant == 'root'
        run: echo "HCLOUD_TOKEN=${{ secrets.hcloud_token_root }}" >> $GITHUB_ENV
      - name: Set tokens correctly (alleaffengaffen)
        if: github.event.inputs.tenant == 'alleaffengaffen'
        run: echo "HCLOUD_TOKEN=${{ secrets.hcloud_token_alleaffengaffen }}" >> $GITHUB_ENV
      - name: Get box ID
        if: always()
        run: |
          SERVER_ID=$(curl --fail-with-body -sSL -X GET -H "Authorization: Bearer ${{ env.HCLOUD_TOKEN }}" \
            https://api.hetzner.cloud/v1/servers \
            | jq ".servers[] | select(.name==\"${{ github.event.inputs.hostname }}\") | .id" \
            | tr -d "\"")
          echo "SERVER_ID=$SERVER_ID" >> $GITHUB_ENV
      - name: Delete box
        if: always()
        run: |
          curl --fail-with-body -sSL -X DELETE -H "Authorization: Bearer ${{ env.HCLOUD_TOKEN }}" \
          "https://api.hetzner.cloud/v1/servers/${{ env.SERVER_ID }}"